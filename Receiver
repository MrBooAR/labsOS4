#pragma warning(disable : 4996)
#include <iostream>
#include <windows.h>
#include <process.h>
#include <string>
#include <fstream>
using namespace std;
CRITICAL_SECTION criticalSection;
const size_t MAX_MESSAGE_SIZE = 200;
int main() {
    InitializeCriticalSection(&criticalSection);
    char* fileName = new char[MAX_MESSAGE_SIZE];
    cout << "Enter name of file:" << endl;
    cin >> fileName;
    int sendersNumber;
    cout << "Enter number of senders:" << endl;
    cin >> sendersNumber;
    STARTUPINFO* startupInfo = new STARTUPINFO[sendersNumber];
    PROCESS_INFORMATION* processInformation = new PROCESS_INFORMATION[sendersNumber];
    HANDLE* events = new HANDLE[sendersNumber];
    HANDLE* senders = new HANDLE[sendersNumber];
    SECURITY_ATTRIBUTES securityAttributes = { sizeof(SECURITY_ATTRIBUTES), 0, TRUE };
    HANDLE startEvent = CreateEvent(&securityAttributes, FALSE, FALSE, LPCWSTR("StartEvent"));
    for (int i = 0; i < sendersNumber; i++) {
        char* dataForSender = new char[MAX_MESSAGE_SIZE];
        strcpy(dataForSender, "");
        strcat(dataForSender, "Sender.exe");
        strcat(dataForSender, fileName);
        ZeroMemory(&startupInfo[i], sizeof(STARTUPINFO));
        ZeroMemory(&processInformation[i], sizeof(PROCESS_INFORMATION));
        startupInfo[i].cb = sizeof(STARTUPINFO);
        char* tmp = new char[20];
        char p[10];
        strcpy(tmp, "Event");
        strcat(tmp, itoa(i, p, 10));
        strcat(dataForSender, " ");
        strcat(dataForSender, tmp);
        events[i] = CreateEvent(&securityAttributes, FALSE, FALSE, LPCWSTR(tmp));
        if (!CreateProcess(NULL, LPWSTR(dataForSender),
            NULL, NULL, TRUE,
            CREATE_NEW_CONSOLE, NULL,
            NULL, &startupInfo[i], &processInformation[i])) {
            cout << "Error" << endl;
            cout << "Process is not created" << endl;;
            return GetLastError();
        }
        senders[i] = processInformation[i].hProcess;
    }
     WaitForMultipleObjects(sendersNumber, events, TRUE, INFINITE);
    SetEvent(startEvent);
    while (WaitForMultipleObjects(sendersNumber, senders, TRUE, 0) == WAIT_TIMEOUT) {
        EnterCriticalSection(&criticalSection);
        cout << "Input 'E' for trying to read file: " << endl;
        char* command;
        cin >> command;
        if (strcmp(command, "E")) {
            break;
        }
        ifstream fin;
        if (fin.is_open() != false) {
            fin.open(fileName, fstream::binary);
            char* message;
            for (int i = 0;i < 2;i++) {
                fin.read(message, sizeof(message));
                cout << message << " ";
            }
            fin.close();
        }
        else {
            cout << "Error" << endl;
            cout << "File is not open" << endl;
        }
        LeaveCriticalSection(&criticalSection);
    }
    for (int i = 0; i < sendersNumber; i++) {
        CloseHandle(processInformation[i].hThread);
        CloseHandle(processInformation[i].hProcess);
        CloseHandle(events[i]);
    }
    CloseHandle(startEvent);
    return 0;
}
